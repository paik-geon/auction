<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”Œë ˆì´ì–´ ê²½ë§¤ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        /* (CSS ë¶€ë¶„) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

        /* --- ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë° ë°°ê²½ --- */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a2e;
            color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .auction-container {
            width: 1200px;
            background-color: #212133;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            padding: 10px 20px 20px 20px; 
            margin-top: 0; 
            border-radius: 0 0 5px 5px;
        }

        /* --- ìƒë‹¨: íŒ€ì¥ ë° í˜„ì¬ ê²½ë§¤ ì •ë³´ --- */
        
        .manager-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px;
            margin-bottom: 15px;
        }

        .manager-card {
            background-color: #2c2c45;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border: 2px solid transparent;
            position: relative;
        }

        .leading {
            border-color: #ff0000;
        }
        
        .manager-name { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .manager-coin { font-size: 1.5em; color: #00ff99; }
        .manager-online { position: absolute; top: 5px; right: 5px; font-size: 0.8em; color: #ffcc00; }

        /* --- ì¤‘ì•™: ì„ ìˆ˜ ì •ë³´ ë° ê²½ë§¤ íŒ --- */
        .main-section {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            height: 500px; 
        }

        .player-info {
            width: 30%;
            background-color: #383850;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .player-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #ffcc00;
            padding-bottom: 10px;
        }

        /* ì„ ìˆ˜ ì•„ë°”íƒ€: ì •ì› ìœ ì§€ */
        .player-avatar { 
            width: 100px; 
            height: 100px; 
            background-color: #555577; 
            border-radius: 50%; 
            margin: 10px auto; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9em;
            overflow: hidden;
            white-space: nowrap; 
        }
        /* ì„ ìˆ˜ ì´ë¦„ + ì½”ë©˜íŠ¸ ì˜ì—­ ê³ ì • ë†’ì´ */
        .player-name-comment {
            text-align: center;
            min-height: 72px;          /* 2ì¤„ ì •ë„ ë“¤ì–´ê°€ë„ ë†’ì´ ìœ ì§€ */
            display: flex;
            flex-direction: column;
            justify-content: center;   /* ìœ„ì•„ë˜ ê°€ìš´ë° ì •ë ¬ */
        }

        /* ì´ë¦„/ì½”ë©˜íŠ¸ëŠ” ì—¬ë°±ë§Œ ì‚´ì§ */
        .player-name-comment h3,
        .player-name-comment p {
            margin: 4px 0;
        }
        
        /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ (BIDDING) */
        .time-count { font-size: 2.5em; font-weight: bold; color: #ff6666; text-align: center; margin-top: 10px;}
        
        /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ (PAUSED - ì¼ë°˜ ë©”ì‹œì§€) */
        .time-paused { font-size: 1.5em; font-weight: bold; color: #00ff99; text-align: center; margin-top: 10px;} 

        /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ (PAUSED - 5ì´ˆ ì¹´ìš´íŠ¸ë‹¤ìš´ ê°•ì¡°) */
        .time-countdown { 
            font-size: 3.5em; 
            font-weight: bold; 
            color: #ffcc00; 
            text-align: center; 
            margin-top: 10px;
            animation: pulse 1s infinite alternate; 
        }

        @keyframes pulse {
            from { transform: scale(1.0); opacity: 1; }
            to { transform: scale(1.1); opacity: 0.8; }
        }

        .bid-panel {
            width: 70%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .auction-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px;
            flex-grow: 1; 
            min-height: 0;
        }

        .bid-slot {
            background-color: #383850;
            border-radius: 8px;
            text-align: center;
            padding: 15px 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* íšë“ ì„ ìˆ˜ ëª©ë¡ ê°œë³„ í•­ëª© ìŠ¤íƒ€ì¼ */
        .player-list-item {
            font-size: 1.1em; 
            margin: 5px 0;
            font-weight: bold;
        }
        .player-list-item.acquired {
            color: #00ff99; 
        }
        .player-list-item.empty {
            color: #555; 
            height: 1.3em; 
        }
        /* ì„ ìˆ˜ëª…ì€ í°íŠ¸ í¬ê¸° ì¡°ì • */
        .player-name-text {
            font-size: 0.9em;
            font-weight: normal;
            display: block;
            margin-top: 2px;
            color: #ccc;
        }


        .current-bid-info {
            text-align: center;
            padding: 10px;
            background-color: #ff0000;
            border-radius: 5px;
            font-size: 1.5em;
            font-weight: bold;
        }

        /* --- ê²½ë§¤ ìˆœì„œ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ --- */
        #auction-queue {
            margin-top: 15px;
            padding: 10px;
            background-color: #2c2c45;
            border-radius: 5px;
            overflow-y: auto;
            flex-grow: 1; 
            min-height: 100px;
        }
        .queue-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px dashed #444;
            font-size: 0.9em;
        }
        .queue-item.next {
            font-weight: bold;
            color: #ffcc00;
        }
        .queue-tier { color: #aaaaaa; }

        /* --- í•˜ë‹¨: ì±„íŒ… ë° ì…ì°°/ê²°ê³¼ --- */
        .bottom-section {
            display: flex;
            gap: 20px;
            height: 300px; 
        }

        .chat-area {
            width: 50%;
            height: 100%; 
            background-color: #383850;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }
        .chat-log { flex-grow: 1; overflow-y: auto; margin-bottom: 10px; border-bottom: 1px solid #555; }
        .chat-input-form { display: flex; }
        .chat-input { flex-grow: 1; padding: 8px; border: none; border-radius: 4px 0 0 4px; background-color: #2c2c45; color: white; }
        .chat-send-btn { padding: 8px 15px; border: none; border-radius: 0 4px 4px 0; background-color: #00ff99; color: #1a1a2e; cursor: pointer; font-weight: bold; }

        /* --- ì±„íŒ… UI ê°œì„  ìŠ¤íƒ€ì¼ --- */
        .chat-message {
            margin: 3px 0;
            padding: 5px;
            border-radius: 3px;
            font-size: 0.95em;
        }
        .chat-system {
            background-color: #4a2c4d; 
            color: #ffcc00;
            font-weight: bold;
        }
        .chat-manager {
            background-color: #314d64; 
            color: #ffffff;
        }
        .chat-bid {
            background-color: #4c4a2c; 
            color: #ffcc00;
            font-weight: bold;
        }
        
        /* --- ì…ì°° íŒ¨ë„ --- */
        .action-panel {
            width: 50%;
            height: 100%; 
            background-color: #383850;
            border-radius: 8px;
            padding: 15px;
        }
        .bid-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .bid-controls input {
            padding: 10px;
            flex-grow: 1;
            min-width: 100px;
            background-color: #2c2c45;
            border: 1px solid #555;
            color: white;
            border-radius: 4px;
        }
        .bid-btn {
            padding: 10px 15px;
            background-color: #ffcc00;
            color: #1a1a2e;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .bid-btn:hover:not(:disabled) { background-color: #ff9900; }
        .bid-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* --- ì¸ì¦ ë° ê´€ë¦¬ì íŒ¨ë„ ìˆ˜ì •: í¬ê¸°ë¥¼ ë‚´ìš©ì— ë§ê²Œ ì¡°ì • --- */
        #auth-panel {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .auth-box {
            background-color: #2c2c45;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        .auth-box input {
            padding: 10px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            background-color: #1a1a2e;
            color: white;
            min-width: 250px; 
        }
        .auth-box button { padding: 10px 20px; background-color: #00ff99; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="auth-panel">
        <div class="auth-box">
            <h2>ê²½ë§¤ ì ‘ì†</h2>
            <p>OTPë¥¼ ì…ë ¥í•˜ì—¬ íŒ€ì¥/ê´€ë¦¬ìë¡œ ì ‘ì†í•˜ê±°ë‚˜, ë¹ˆì¹¸ìœ¼ë¡œ ì°¸ê´€ì¸ ì ‘ì†</p>
            <input type="text" id="otp-input" placeholder="OTP ì…ë ¥" required>
            <button onclick="authenticate()">ì ‘ì†</button>
            <p id="auth-message" style="color: #ff6666;"></p>
        </div>
    </div>

    <div class="auction-container" style="display: none;">
        
        <div class="manager-grid" id="manager-grid">
            </div>
        <hr style="margin-top: 10px; margin-bottom: 10px;">

        <div class="main-section">
            <div class="player-info">
                <div class="player-header">
                    <span id="player-tier" style="font-size: 1.5em; color: #ffcc00;">-</span> í‹°ì–´
                </div>
                <div class="player-avatar" id="player-avatar">
                    
                </div>
                <div class="player-name-comment" style="text-align: center;">
                    <h3 id="current-player-name">ì„ ìˆ˜ëª…</h3>
                    <p id="player-comment">ì½”ë©˜íŠ¸: -</p>
                </div>
                
                <div class="time-count" id="timer-display">
                    00:00
                </div>
                
                <div id="auction-queue">
                    <p style="margin-top: 0; font-weight: bold;">ê²½ë§¤ ìˆœì„œ:</p>
                    <div id="auction-queue-list">
                        </div>
                </div>
            </div>

            <div class="bid-panel">
                <div class="current-bid-info" id="current-bid-display">
                    í˜„ì¬ ìµœê³  ì…ì°°ê°€: 0 ì½”ì¸ (ë‚™ì°°ì ì—†ìŒ)
                </div>
                <div class="auction-board" id="auction-board">
                    </div>
            </div>
        </div>
        <hr style="margin-top: 10px; margin-bottom: 10px;">

        <div class="bottom-section">
            <div class="chat-area">
                <div class="chat-log" id="chat-log">
                    </div>
                <form class="chat-input-form" onsubmit="sendChat(event)">
                    <input type="text" class="chat-input" id="chat-message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
                    <button type="submit" class="chat-send-btn">ì „ì†¡</button>
                </form>
            </div>

            <div class="action-panel">
                <h3 id="action-panel-title">ì°¸ê´€ì¸ ì •ë³´</h3>
                
                <div id="manager-bid-panel" style="display: none;">
                    <h4>ë‚˜ì˜ ì½”ì¸: <span id="my-current-coin">1000</span></h4>
                    <p>ë‹¤ìŒ ì…ì°° ê¸ˆì•¡: <span id="min-bid-amount">5</span></p>
                    <input type="number" id="bid-input-amount" value="5" min="5" placeholder="ì§ì ‘ ì…ë ¥">
                    <div class="bid-controls">
                        <button class="bid-btn" onclick="placeBid(5)">+5</button>
                        <button class="bid-btn" onclick="placeBid(10)">+10</button>
                        <button class="bid-btn" onclick="placeBid(50)">+50</button>
                        <button class="bid-btn" onclick="placeBid(100)">+100</button>
                        <button class="bid-btn" style="background-color: #00ff99;" onclick="submitBid()" id="submit-bid-btn">ì…ì°°</button>
                    </div>
                </div>

                <div id="admin-controls" style="display: none;">
                    <h3>ê´€ë¦¬ì ì œì–´</h3>
                    <button onclick="adminStartAuction()">ê²½ë§¤ ì‹œì‘/ì¬ê°œ</button>
                    <button onclick="adminEndBid()">ê°•ì œ ë‚™ì°°/ìœ ì°°</button>
                    <hr>
                    <p>íŒ€ì¥ ì½”ì¸/ì •ë³´ ìˆ˜ì • (ì˜ˆ: T-001, 500)</p>
                    <input type="text" id="admin-target-otp" placeholder="OTP">
                    <input type="number" id="admin-new-coin" placeholder="ìƒˆ ì½”ì¸">
                    <button onclick="adminUpdateManager()">íŒ€ì¥ ì½”ì¸ ìˆ˜ì •</button>
                </div>

                <div id="viewer-summary">
                    <p>ê²½ë§¤ ìƒí™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ê´€ì „í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- JavaScript ë° SocketIO ë¡œì§ ---

    const SERVER_URL = document.location.origin;

    let socket;
    let userSession = {
        type: 'viewer', 
        otp: null,
        id: null,
        name: 'ì°¸ê´€ì¸'
    };
    let currentAuctionData = {};
    let timerInterval;
    let lastPlayer = null;
    
    // ì´ì „ ì„ ìˆ˜ ì´ë¦„ ê¸°ì–µí•´ì„œ ë°”ë€” ë•Œë§Œ ì´ˆê¸°í™”
    let lastPlayerName = null;
    
    // ì„ì‹œ ì„ ìˆ˜ ì½”ë©˜íŠ¸ ë°ì´í„°
    const PLAYER_COMMENTS = {
        'ê²½ë¯¼': 'FPS 7ì²œ ì‹œê°„ì˜ ë°•ì¹˜ê¸° ê³µë£¡!!!', 'ëŒ€ê· ': 'ì˜ì›…ì˜ íƒ„ìƒì„ ì°¾ìŠµë‹ˆë‹¤.', 'í˜¸ì¤€': 'ì§€ëŠ¥ì ì¸ í”Œë ˆì´ë¡œ íŒ€ì„ ì´ëŒê² ìŠµë‹ˆë‹¤.',
        'ë¯¼ì¬': 'íŒ€ì›Œí¬ê°€ í•µì‹¬ì…ë‹ˆë‹¤.', 'í˜„ì¤€': 'ì¡°ìš©í•˜ì§€ë§Œ ê°•í•©ë‹ˆë‹¤.', 'ë²”ìˆ˜': 'ìŠ¹ë¦¬ëŠ” ì–¸ì œë‚˜ ë‚˜ì˜ ê²ƒ.',
        'ì„±ë¯¼': 'ì •í™•í•œ ìƒ·ì„ ê¸°ëŒ€í•˜ì„¸ìš”.', 'íƒœì—°': 'íŒ€ì„ ìœ„í•œ í¬ìƒë„ ë§ˆë‹¤í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'ì„ ìš°': 'ì „ëµì ì¸ í”Œë ˆì´ë¥¼ ë³´ì—¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.',
        'ì§„í˜¸': 'ë¯¸ì¹œ ì—ì„ì˜ ì†Œìœ ì.', 'ì¤€ì„': 'ìƒëŒ€ë¥¼ ì••ë„í•˜ëŠ” í”¼ì§€ì»¬.', 'ë°±ê±´': 'ìœ ì°° ë¶€íƒ.',
        'ê¸°ë³¸': 'ì„ ìˆ˜ ì •ë³´ ì¤€ë¹„ ì¤‘...'
    };


    // --- 1. ì¸ì¦ ë° ì ‘ì† ---
    function authenticate() {
        const otpInput = document.getElementById('otp-input').value;
        const authMessage = document.getElementById('auth-message');
        
        // ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œ URLì„ ì§ì ‘ ì§€ì •í•´ì•¼ fetch ì˜¤ë¥˜ë¥¼ í”¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        const authUrl = `${SERVER_URL}/auth`;

        fetch(authUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `otp=${otpInput}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                userSession = data.session;
                
                document.getElementById('auth-panel').style.display = 'none';
                document.querySelector('.auction-container').style.display = 'block';
                document.getElementById('action-panel-title').textContent = `${userSession.name}ë‹˜ì˜ (${userSession.type}) íŒ¨ë„`;
                
                // ê¶Œí•œì— ë”°ë¥¸ íŒ¨ë„ í™œì„±í™”
                const isManager = userSession.type === 'manager';
                const isAdmin = userSession.type === 'admin';
                document.getElementById('manager-bid-panel').style.display = isManager ? 'block' : 'none';
                document.getElementById('admin-controls').style.display = isAdmin ? 'block' : 'none';
                document.getElementById('viewer-summary').style.display = (!isManager && !isAdmin) ? 'block' : 'none';

                connectSocketIO();
            } else {
                authMessage.textContent = data.message || 'ì¸ì¦ ì‹¤íŒ¨';
            }
        })
        .catch(error => {
            console.error('ì¸ì¦ ìš”ì²­ ì‹¤íŒ¨:', error);
            authMessage.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨. (ì•±ì´ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”)';
        });
    }

    function connectSocketIO() {
        // ë°°í¬ í™˜ê²½ì—ì„œëŠ” ì„œë²„ URLì„ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤. ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” document.location.origin ì‚¬ìš©.
        socket = io.connect(SERVER_URL);

        socket.on('connect', () => {
            socket.emit('authenticate', { otp: userSession.otp });
        });

        socket.on('auction_update', updateUI);
        socket.on('manager_data_update', updateManagerDataOnly);
        socket.on('bid_error', (data) => {
            alert(`ì…ì°° ì˜¤ë¥˜: ${data.message}`);
        });
        socket.on('chat_message', appendChatMessage);
    }
    
    // --- 2. UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ---
    
    function updateUI(data) {
        currentAuctionData = data;

        // ğŸ”¥ 0. í”Œë ˆì´ì–´ ë³€ê²½ ê°ì§€
        const playerChanged = data.current_player !== lastPlayerName;
        lastPlayerName = data.current_player;

        // 1. íƒ€ì´ë¨¸ ë° ìƒíƒœ ì—…ë°ì´íŠ¸
        clearInterval(timerInterval);
        startTimer(data.timer_remaining, data.state);

        // 2. í˜„ì¬ ê²½ë§¤ ì •ë³´ ì—…ë°ì´íŠ¸
        const nameEl = document.getElementById('current-player-name');
        const tierEl = document.getElementById('player-tier');
        const commentEl = document.getElementById('player-comment');

        if (nameEl) {
            if (data.state === 'ENDED') {
                nameEl.textContent = 'ê²½ë§¤ ì¢…ë£Œ';
            } else if (data.current_player) {
                nameEl.textContent = data.current_player;
            } else {
                nameEl.textContent = 'ëŒ€ê¸° ì¤‘';
            }
        }
    
        if (tierEl) {
            tierEl.textContent = data.player_tier || '-';
        }

        if (commentEl) {
            const key =
                data.current_player && PLAYER_COMMENTS[data.current_player]
                    ? data.current_player
                    : 'ê¸°ë³¸';
            commentEl.textContent = `ì½”ë©˜íŠ¸: ${PLAYER_COMMENTS[key]}`;
        }

        // ğŸ”¥ 2-1. ì„ ìˆ˜ ë°”ë€” ë•Œë§ˆë‹¤ ì…ì°° ì¸í’‹ 5ë¡œ ì´ˆê¸°í™”
        if (playerChanged) {
            const bidInput = document.getElementById('bid-input-amount');
            if (bidInput) {
                bidInput.value = 5;
            }
        }

        // 3. ê²½ë§¤ ìˆœì„œ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        updateAuctionQueue(data.player_list, data.player_index);

        // 4. ìµœê³  ì…ì°°ê°€ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ì½”ë“œ ê·¸ëŒ€ë¡œ) ...
        }

        // 4. ìµœê³  ì…ì°°ê°€ ì—…ë°ì´íŠ¸
        let leadingManagerName = 'ì—†ìŒ';
        if (data.leading_manager_id) {
            // managers ê°ì²´ë¥¼ ìˆœíšŒí•˜ì—¬ idê°€ ì¼ì¹˜í•˜ëŠ” ë§¤ë‹ˆì € ì´ë¦„ì„ ì°¾ìŠµë‹ˆë‹¤.
            for (const otp in data.managers) {
                if (data.managers[otp].id === data.leading_manager_id) {
                    leadingManagerName = data.managers[otp].name;
                    break;
                }
            }
        }
        
        // [ìˆ˜ì • ë°˜ì˜] ì…ì°°ìê°€ ì—†ì„ ê²½ìš° 'ì—†ìŒ'ìœ¼ë¡œ í‘œì‹œ
        document.getElementById('current-bid-display').textContent = 
            `í˜„ì¬ ìµœê³  ì…ì°°ê°€: ${data.current_price} ì½”ì¸ (${leadingManagerName})`;
            
        // 5. íŒ€ì¥ ì •ë³´ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
        updateManagerGrid(data.managers, data.leading_manager_id);
        
        // 6. ì…ì°° íŒ¨ë„ ì—…ë°ì´íŠ¸ (íŒ€ì¥ ê¶Œí•œì¼ ê²½ìš°)
        if (userSession.type === 'manager') {
            updateBidPanel(data);
        }
        
        // 7. ê²½ë§¤íŒ (íšë“ ì„ ìˆ˜ ëª©ë¡) ì—…ë°ì´íŠ¸
        updateAuctionBoard(data.managers);
    }
    
    function updateManagerDataOnly(data) {
        updateManagerGrid(data.managers, currentAuctionData.leading_manager_id);
        updateAuctionBoard(data.managers);
    }
    
    function updateBidPanel(data) {
         const bidBtn = document.getElementById('submit-bid-btn');
         const bidInput = document.getElementById('bid-input-amount');
         const minBidDisplay = document.getElementById('min-bid-amount');
         const myManager = data.managers[userSession.otp];
         
         if (myManager) {
             document.getElementById('my-current-coin').textContent = myManager.coin;
             
             // ì…ì°° ê°€ëŠ¥ ì—¬ë¶€: BIDDING ìƒíƒœì—ì„œë§Œ ê°€ëŠ¥
             const isBiddingTime = data.state === 'BIDDING';
             bidBtn.disabled = !isBiddingTime;
             
             // ë‹¤ìŒ ì…ì°° ê¸ˆì•¡ ê³„ì‚°: (í˜„ì¬ ìµœê³ ê°€ + 5)
             const minBid = data.current_price + 5;
             minBidDisplay.textContent = minBid;
             bidInput.setAttribute('min', minBid);
             
             // ì…ë ¥ ê°’ ë³´ì •
             const currentInputValue = parseInt(bidInput.value) || 0;
             if (currentInputValue < minBid || currentInputValue < data.current_price) {
                 bidInput.value = minBid;
             }
         }
    }

    function updateAuctionQueue(playerList, currentIndex) {
        const listContainer = document.getElementById('auction-queue-list');
        listContainer.innerHTML = '';
        
        // í˜„ì¬ ì„ ìˆ˜ë¶€í„° ìµœëŒ€ 10ê°œ í•­ëª©ë§Œ í‘œì‹œ
        const start = currentIndex; 
        const displayLimit = Math.min(playerList.length, start + 10); 

        for (let i = start; i < displayLimit; i++) {
            const player = playerList[i];
            const item = document.createElement('div');
            
            let statusText = '';
            let className = 'queue-item';

            if (i === currentIndex) {
                statusText = '(í˜„ì¬)';
                className += ' next';
            } else {
                statusText = `ì˜ˆì •`;
            }
            
            item.className = className;
            item.innerHTML = `
                <span>${player.name}</span>
                <span class="queue-tier">${player.tier} í‹°ì–´ ${statusText}</span>
            `;
            listContainer.appendChild(item);
        }
    }

    function updateManagerGrid(managers, leadingId) {
        const grid = document.getElementById('manager-grid');
        grid.innerHTML = '';
        
        for (const otp in managers) {
            const manager = managers[otp];
            const isLeading = manager.id === leadingId;
            const card = document.createElement('div');
            card.className = `manager-card ${isLeading ? 'leading' : ''}`;
            
            const avatarHtml = `<div class="player-avatar" style="width:50px; height:50px; margin: 0 auto 5px;"></div>`;
            
            card.innerHTML = `
                ${avatarHtml}
                <div class="manager-online" style="color: ${manager.is_online ? '#00ff99' : '#ff6666'};">${manager.is_online ? 'ON' : 'OFF'}</div>
                <div class="manager-name">${manager.name} (${manager.id})</div>
                <div class="manager-coin">${manager.coin}</div>
            `;
            grid.appendChild(card);
        }
    }
    
    function updateAuctionBoard(managers) {
        const board = document.getElementById('auction-board');
        board.innerHTML = '';
        
        const tiers = ['A', 'B', 'C', 'D'];

        for (const otp in managers) {
            const manager = managers[otp];
            const slot = document.createElement('div');
            slot.className = 'bid-slot';
            
            const teamPlayers = Object.values(manager.team);
            let playerListHtml = '';
            
            tiers.forEach(tier => {
                const playersInTier = teamPlayers.filter(p => p.tier === tier);
                const playerNames = playersInTier.map(p => p.name).join(', '); 
                
                let playerStatusHtml = '';
                let itemClass = 'player-list-item';

                if (playersInTier.length > 0) {
                    // ì„ ìˆ˜ íšë“ ì‹œ
                    itemClass += ' acquired';
                    playerStatusHtml = `
                        ${tier} í‹°ì–´
                        <span class="player-name-text">${playerNames}</span>
                    `;
                } else {
                    // ì„ ìˆ˜ ë¯¸íšë“ ì‹œ: ë¹ˆì¹¸ ë° í‹°ì–´ í‘œì‹œ
                    itemClass += ' empty';
                    playerStatusHtml = `${tier} í‹°ì–´`;
                }


                playerListHtml += `<p class="${itemClass}">${playerStatusHtml}</p>`;
            });
            
            slot.innerHTML = `
                <div class="bid-manager" style="font-size: 1.5em; font-weight: bold; margin-bottom: 10px;">${manager.name} íŒ€</div>
                <div style="flex-grow: 1; overflow-y: auto;">
                    ${playerListHtml}
                </div>
            `;
            board.appendChild(slot);
        }
    }
    
    function startTimer(seconds, state) {
        let remaining = seconds;
        const display = document.getElementById('timer-display');
        
        const update = () => {
            const sec = remaining % 60;
            const min = Math.floor(remaining / 60);
            const timeString = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            
            if (state === 'PAUSED') {
                if (remaining <= 5 && remaining > 0) {
                    // 5ì´ˆ ì´í•˜ ì¹´ìš´íŠ¸ë‹¤ìš´ (ê°•ì¡°)
                    display.className = 'time-countdown'; 
                    display.textContent = remaining;
                } else if (remaining > 0) {
                    // ì¼ë°˜ PAUSED ë©”ì‹œì§€ (ëª‡ ì´ˆ í›„ ì‹œì‘)
                    display.className = 'time-paused';
                    display.textContent = `ì¤€ë¹„ ì¤‘... (${timeString}ì´ˆ í›„ ì‹œì‘)`;
                } else {
                    // 0ì´ˆì¼ ê²½ìš°, ì„œë²„ì—ì„œ ìƒíƒœ ì „í™˜ì„ ê¸°ë‹¤ë¦¼
                    display.className = 'time-paused';
                    display.textContent = `ì‹œì‘ ì¤‘...`;
                }
            } else if (state === 'BIDDING') {
                display.className = 'time-count';
                display.textContent = timeString;
            } else if (state === 'ENDED' || state === 'READY') {
                 display.className = 'time-count';
                 display.textContent = state === 'ENDED' ? 'ê²½ë§¤ ì¢…ë£Œ' : 'ì¤€ë¹„';
                 clearInterval(timerInterval);
                 return;
            }
            
            if (remaining <= 0) {
                // íƒ€ì´ë¨¸ ì¢…ë£Œ ì‹œ 0ìœ¼ë¡œ ê³ ì •
                clearInterval(timerInterval);
            }
            remaining--;
        };
        
        update();
        timerInterval = setInterval(update, 1000);
    }

    // --- 3. íŒ€ì¥ ì•¡ì…˜ (ì…ì°°) ---

    function placeBid(increment) {
        const input = document.getElementById('bid-input-amount');
        const minBid = parseInt(document.getElementById('min-bid-amount').textContent);
        
        const currentInputValue = parseInt(input.value) || 0;
        
        // í˜„ì¬ ì…ë ¥ê°’ë³´ë‹¤ ìµœì†Œ ì…ì°°ê°€ê°€ ë†’ë‹¤ë©´, ìµœì†Œ ì…ì°°ê°€ë¶€í„° ì‹œì‘
        let baseValue = Math.max(currentAuctionData.current_price, currentInputValue); 
        if (baseValue === 0) baseValue = 0; // ì´ˆê¸°ê°’ 0 ì²˜ë¦¬
        
        const newBid = Math.max(minBid, baseValue + increment);
        
        input.value = newBid;
    }

    function submitBid() {
        if (userSession.type !== 'manager' || currentAuctionData.state !== 'BIDDING') {
            alert('ì…ì°° ê¶Œí•œì´ ì—†ê±°ë‚˜ ê²½ë§¤ ì¤‘ì´ ì•„ë‹™ë‹ˆë‹¤.');
            return;
        }
        
        const bidAmount = parseInt(document.getElementById('bid-input-amount').value);
        const minBid = parseInt(document.getElementById('min-bid-amount').textContent);
        const myCoin = parseInt(document.getElementById('my-current-coin').textContent);

        if (bidAmount < minBid) {
            alert(`ìµœì†Œ ì…ì°° ê¸ˆì•¡ì€ ${minBid} ì½”ì¸ì…ë‹ˆë‹¤.`);
            return;
        }
        if (bidAmount > myCoin) {
            alert('ë³´ìœ  ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
            return;
        }
        
        const bidIncrement = bidAmount - currentAuctionData.current_price;

        socket.emit('place_bid', {
            otp: userSession.otp,
            amount: bidIncrement
        });
        
        // ì…ì°° í›„ ë‹¤ìŒ ì…ì°° ì˜ˆìƒ ê¸ˆì•¡ìœ¼ë¡œ ì¸í’‹ ì´ˆê¸°í™”
        document.getElementById('bid-input-amount').value = bidAmount + 5; 
    }

    // --- 4. ì±„íŒ… ---
    
    function appendChatMessage(data) {
        const log = document.getElementById('chat-log');
        const messageElement = document.createElement('p');
        
        const sender = data.name || 'ì•Œë¦¼';
        let className = 'chat-message';
        
        if (sender === 'ì‹œìŠ¤í…œ') {
            className += ' chat-system';
        } else if (data.message.includes('ì…ì°°:')) {
            className += ' chat-bid';
        } else {
            className += ' chat-manager';
        }
        
        messageElement.className = className;
        messageElement.innerHTML = `[${sender}] ${data.message}`;
        log.appendChild(messageElement);
        log.scrollTop = log.scrollHeight;
    }
    
    function sendChat(event) {
        event.preventDefault();
        const input = document.getElementById('chat-message-input');
        const message = input.value.trim();
        
        if (message) {
            socket.emit('chat_message', {
                name: userSession.name,
                message: message
            });
            input.value = '';
        }
    }

    // --- 5. ê´€ë¦¬ì ì•¡ì…˜ ---
    
    function adminStartAuction() {
        if (userSession.type === 'admin') {
            socket.emit('admin_start_auction');
            alert('ê²½ë§¤ ì‹œì‘/ì¬ê°œ ëª…ë ¹ ì „ì†¡');
        }
    }
    
    function adminEndBid() {
        if (userSession.type === 'admin') {
            const confirmEnd = confirm("í˜„ì¬ ê²½ë§¤ë¥¼ ê°•ì œ ì¢…ë£Œí•˜ê³  ë‚™ì°°/ìœ ì°° ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (confirmEnd) {
                socket.emit('admin_end_bid');
                alert('ê°•ì œ ë‚™ì°°/ìœ ì°° ëª…ë ¹ ì „ì†¡');
            }
        }
    }

    function adminUpdateManager() {
        if (userSession.type === 'admin') {
            const otp = document.getElementById('admin-target-otp').value;
            const coin = document.getElementById('admin-new-coin').value;
            
            if (otp && coin) {
                 socket.emit('admin_update_manager', { otp: otp, coin: parseInt(coin) });
                 alert(`${otp}ì˜ ì½”ì¸ì„ ${coin}ìœ¼ë¡œ ìˆ˜ì • ëª…ë ¹ ì „ì†¡`);
            } else {
                alert('OTPì™€ ìƒˆ ì½”ì¸ì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }
    }
</script>
</body>

</html>



